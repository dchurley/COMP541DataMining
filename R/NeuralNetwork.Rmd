```{r}
#import libraries
library(tidytext)
library(caret)
library(tidyverse)
library(tm)
library(e1071)
library(keras)
```


```{r}
#get the training data
source("Database.R")

data <- SQL_GET_DATA("Tutorial")

data <- data[sample(nrow(data), 1000, replace = FALSE), ]


my_data <- data$text
  
my_data %>% 
   unnest %>% 
   sentimentr::get_sentences() %>% 
   sentimentr::sentiment() %>% 
   mutate(characters = nchar(stripWhitespace(text))) %>% 
   filter(characters >1 ) -> bounded_sentences 
summary(bounded_sentences$sentiment)

```


```{r}
#func to remove all characters but english alphabet letters
removeSpecialChars <- function(x) {
  gsub("[^a-zA-Z ]", "", x)
}


# Create a corpus from text data
corpus <- Corpus(VectorSource(data$text))

# clean the corpus
corpus <- tm_map(corpus, content_transformer(tolower))
corpus <- tm_map(corpus, content_transformer(removeSpecialChars))
corpus <- tm_map(corpus, removeWords, stopwords())
#remove the word said because it's the most common and it's boring
corpus <- tm_map(corpus, removeWords, c("said", "reuters"))
corpus <- tm_map(corpus, stripWhitespace)
#corpus <- tm_map(corpus, stemDocument, language="english")
#creating term matrix with TF-IDF weighting
dtm <-DocumentTermMatrix(corpus,control = list(weighting = function(x) weightTfIdf(x, normalize = TRUE)))
dtm
```


```{r}
spam <- removeSparseTerms(dtm, 0.95)
spam
```



```{r}
dataFrame <- as.data.frame(as.matrix(spam), stringsAsFactors=False)
num_words <- length(dataFrame)
dataFrame$label = data$label
dataFrame
```

```{r}
set.seed(123) # For reproducibility
trainIndex <- createDataPartition(dataFrame$label, p = .8, 
                                  list = FALSE, 
                                  times = 1)
train_data <- dataFrame[trainIndex, ]
test_data <- dataFrame[-trainIndex, ]


# Train a classifier
X_train <- train_data[, !names(train_data) %in% c("label")] %>% as.matrix()
y_train <- train_data$label
X_test <- test_data[, !names(test_data) %in% c("label")] %>% as.matrix()
y_test <- test_data$label

# Define sigmoid activation function
sigmoid <- function(x) {
  1 / (1 + exp(-x))
}

# Define derivative of the sigmoid function
sigmoid_derivative <- function(x) {
  x * (1 - x)
}

# Initialize weights randomly
set.seed(123)
input_units <- num_words
hidden_units <- 64
output_units <- 1

# Randomly initialize weights with mean 0
weights_input_hidden <- matrix(runif(input_units * hidden_units, -1, 1), nrow = input_units)
weights_hidden_output <- matrix(runif(hidden_units * output_units, -1, 1), nrow = hidden_units)

# Define learning rate
learning_rate <- 0.03

# Train the neural network
epochs <- 100
for (epoch in 1:epochs) {
  # Forward propagation
  hidden_layer_input <- X_train %*% weights_input_hidden
  hidden_layer_output <- sigmoid(hidden_layer_input)
  
  output_layer_input <- hidden_layer_output %*% weights_hidden_output
  predicted_output <- sigmoid(output_layer_input)
  
  # Backpropagation
  error <- y_train - predicted_output
  d_predicted_output <- error * sigmoid_derivative(predicted_output)
  
  error_hidden_layer <- d_predicted_output %*% t(weights_hidden_output)
  d_hidden_layer <- error_hidden_layer * sigmoid_derivative(hidden_layer_output)
  
  # Update weights
  weights_hidden_output <- weights_hidden_output + t(hidden_layer_output) %*% d_predicted_output * learning_rate
  weights_input_hidden <- weights_input_hidden + t(X_train) %*% d_hidden_layer * learning_rate
  
  # Calculate loss
  loss <- sum((y_train - predicted_output) ^ 2) / nrow(X_train)
  
  cat("Epoch:", epoch, "Loss:", loss, "\n")
}

# Predictions
hidden_layer_input <- X_test %*% weights_input_hidden
hidden_layer_output <- sigmoid(hidden_layer_input)
  
output_layer_input <- hidden_layer_output %*% weights_hidden_output
predicted_output <- sigmoid(output_layer_input)

# Convert predicted probabilities to binary predictions
predictions <- ifelse(predicted_output > 0.5, 1, 0)

# Calculate accuracy
accuracy <- sum(predictions == y_test) / length(y_test)
cat("Test Accuracy:", accuracy, "\n")
```

